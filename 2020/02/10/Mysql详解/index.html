<!DOCTYPE html>



  



<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">

  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/avatar.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/avatar.png?v=5.1.4">


  <link rel="mask-icon" href="/images/avatar.png?v=5.1.4" color="#222">





  <meta name="keywords" content="Mysql,">










<meta name="description" content="Talk is cheap. Show me the code.">
<meta name="keywords" content="Mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="Mysql详解">
<meta property="og:url" content="http://qx-ljy.cn/2020/02/10/Mysql详解/index.html">
<meta property="og:site_name" content="青夕的博客">
<meta property="og:description" content="Talk is cheap. Show me the code.">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://qx-ljy.cn/2020/02/10/Mysql详解/C:%5CUsers%5C%E5%A4%95%5CDesktop%5Cxblog%5Csource_posts%5CMysql%E8%AF%A6%E8%A7%A3%5C1075436-20190215135724690-741976355.png">
<meta property="og:image" content="http://qx-ljy.cn/2020/02/10/Mysql详解/C:%5CUsers%5C%E5%A4%95%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200210133758200.png">
<meta property="og:image" content="https://img2018.cnblogs.com/blog/1075436/201903/1075436-20190306160941579-1127184320.png">
<meta property="og:updated_time" content="2020-03-27T07:51:01.810Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mysql详解">
<meta name="twitter:description" content="Talk is cheap. Show me the code.">
<meta name="twitter:image" content="http://qx-ljy.cn/2020/02/10/Mysql详解/C:%5CUsers%5C%E5%A4%95%5CDesktop%5Cxblog%5Csource_posts%5CMysql%E8%AF%A6%E8%A7%A3%5C1075436-20190215135724690-741976355.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://qx-ljy.cn/2020/02/10/Mysql详解/">





  <title>Mysql详解 | 青夕的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

<div class="bg_content">
  <canvas id="canvas"></canvas>
</div>
  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
	<a href="https://github.com/X-ljy" class="github-corner" aria-label="View source on GitHub">
	<svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; 
	top: 0; border: 0; right: 0;" aria-hidden="true">
	<path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z">
	</path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,
	72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/>
	<path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,
	98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,
	40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,
	77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,
	112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,
	141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>
	<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes 
	octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}
	@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner 
	.octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">青夕的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://qx-ljy.cn/2020/02/10/Mysql详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="青夕">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="青夕的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Mysql详解</h1>
        

        <div class="post-meta">

          <span class="post-time">
		  					
				<i class="fa fa-thumb-tack"></i>
				<font color="green">置顶</font>
				<span class="post-meta-divider">|</span>
			
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-10T12:51:16+08:00">
                2020-02-10
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Mysql/" itemprop="url" rel="index">
                    <span itemprop="name">Mysql</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  27
                </span>
              
            </div>
          

          
              <div class="post-description">
                  Talk is cheap. Show me the code.
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Mysql逻辑结构"><a href="#Mysql逻辑结构" class="headerlink" title="Mysql逻辑结构"></a>Mysql逻辑结构</h2><p><img src="//qx-ljy.cn/2020/02/10/Mysql详解/C:%5CUsers%5C%E5%A4%95%5CDesktop%5Cxblog%5Csource_posts%5CMysql%E8%AF%A6%E8%A7%A3%5C1075436-20190215135724690-741976355.png" alt="img"></p>
<h3 id="长连接-and-短连接"><a href="#长连接-and-短连接" class="headerlink" title="长连接 and 短连接"></a>长连接 and 短连接</h3><p><strong>1、什么是长链接？</strong><br>数据库里面，长连接是连接成功后，如果客户端持续有请求，则一直使用同一个链接。</p>
<p><strong>2、什么是短连接？</strong><br>短连接则是指每次执行完很少的几次查询就断开连接，下次查询重新建立一个</p>
<p><strong>3、尽量使用长链接</strong><br>建立连接的过程通常是比较复杂的，所以我建议你在使用中尽量减少建立的动作，也就是使用长连接。</p>
<h3 id="长连接的缺点和解决方案"><a href="#长连接的缺点和解决方案" class="headerlink" title="长连接的缺点和解决方案"></a>长连接的缺点和解决方案</h3><p><strong>1、为什么MySQL占用内存涨得特别快</strong><br>但是全部是用长连接后，你可能会发现，有些时候MySQL占用内存涨得特别快，</p>
<p>这是因为MySQL在执行过程中临时使用的内存管理在连接对象里面的，这些资源会在连接断开的时候才释放，</p>
<p>所以如果长链接积累下来，可能导致内存占用大，被系统强行杀掉，从现象看就是MySQL异常重启了</p>
<p><strong>2、如何解决MySQL占用内存涨得特别快</strong><br>1、定期断开长链接，使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再连接</p>
<p>2、如果你用的是MySQL5.7或更新版本，可以在每次执行一个比较大的操作后，通过执行<strong>mysql_reset_connection</strong>来重新初始化连接资源，这个过程不需要重连或重新做权限验证，但是会将连接回复到刚刚创建完时的状态；</p>
<h3 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h3><ol>
<li>MySQL拿到一个查询请求后，会先到查询缓存看看，之前是不是执行过这条语句，如果有，就直接返回给客户端</li>
<li>如果语句不在查询缓存中，就会继续后面的执行阶段。</li>
<li>执行完成后，执行结果会被存入查询缓存中，</li>
<li>如果查询命中缓存MySQL不需要执行后面的复杂操作，就可以直接返回结果，这个效率会很高</li>
</ol>
<p><strong>为什么大多数情况下不建议使用查询缓存？</strong></p>
<p>1、查询缓存的失效非常频繁，只要有一个表更新，这个表上所有的查询缓存都被清空<br>2、对于更新压力大的数据库来说，查询缓存的命中率会非常低，<br>3、除非你的业务就是有一张静态表，很长时间才会更新一次(比如一个系统配置表)</p>
<p><strong>1、默认语句不实用查询缓存</strong></p>
<p>MySQL提供的按需使用的方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query_cache_type 设置成 DEMAND</span><br></pre></td></tr></table></figure>

<p><strong>2、确定需要查询缓存的语句</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select SQL_CACHE * from T where ID=10；</span><br></pre></td></tr></table></figure>

<h3 id="优化器"><a href="#优化器" class="headerlink" title="优化器"></a>优化器</h3><p><strong>1、优化器的作用</strong><br>1、在表里面有多个索引的时候，决定使用哪个索引</p>
<p>2、多表关联(ioin)的时候，决定各个表的链接顺序</p>
<p><strong>2、举例说明</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from t1 join t2 using(ID) where t1.c=10 and t2.d=20;</span><br></pre></td></tr></table></figure>

<p>既可以先从表 t1 里面取出 c=10 的记录的 ID 值，再根据 ID 值关联到表 t2，再判断 t2 里面 d 的值是否等于20<br>也可以先从表 t2 里面取出 d=20 的记录的 ID 值，再根据 ID 值关联到 t1，再判断 t1 里面 c 的值是否等于10</p>
<p>这两种执行方法的逻辑结果时一样的，但是执行的效率会有不同，而优化器的作用就是决定选择哪一个方案</p>
<h3 id="执行器"><a href="#执行器" class="headerlink" title="执行器"></a>执行器</h3><p><strong>1、没有索引的执行流程</strong><br>1、调用 InnoDB 引擎接口取这个表的第一行，判断 ID 值是不是1，如果不是则跳过，如果是则将这行存在结果集中<br>2、调用引擎接口取”下一行”，重复相同的判断逻辑，直到取到这个表的最后一行<br>3、执行器将上述遍布过程中所有满足条件的行组成的记录集作为结果集返回给客户端。</p>
<p><strong>2、有索引的执行流程</strong><br>第一调用的是”取满足条件的第一行”这个接口，<br>之后循环取”满足条件的下一行”</p>
<h2 id="日志系统"><a href="#日志系统" class="headerlink" title="日志系统"></a>日志系统</h2><p><strong>Undo日志记录某数据被修改前的值，可以用来在事务失败时进行rollback；Redo日志记录某数据块被修改后的值，可以用来恢复未写入data file的已成功事务更新的数据。</strong></p>
<h3 id="undo日志"><a href="#undo日志" class="headerlink" title="undo日志"></a>undo日志</h3><p>Undo Log 是为了实现事务的原子性，在MySQL数据库InnoDB存储引擎中，还用Undo Log来实现多版本并发控制(简称：MVCC)。</p>
<p>Undo Log的原理很简单，为了满足事务的原子性，在操作任何数据之前，首先将数据备份到一个地方（这个存储数据备份的地方称为Undo Log）。然后进行数据的修改。如果出现了错误或者用户执行了ROLLBACK语句，系统可以利用Undo Log中的备份将数据恢复到事务开始之前的状态。<br>除了可以保证事务的原子性，Undo Log也可以用来辅助完成事务的持久化。</p>
<p><strong>缺点</strong></p>
<p>如果每个事务提交前都将数据和undo log写入磁盘(undo log的写入一定先于数据，因为保证undo log完整可以用来回滚事务)，这样会导致大量磁盘IO，因此性能很低；如果将数据缓存一段时间，这样会丧失持久性。所以出现了redolog.</p>
<h3 id="redo-log"><a href="#redo-log" class="headerlink" title="redo log"></a>redo log</h3><p>如果每一次更新操作都需要写进磁盘，然后磁盘找到对应的那条数据，然后在更新，整个过程的IO成本，查找成本都很高。为了解决这个问题，mysql使用WAL（WriteAhead Logging，预写式日志）：先写日志，再写磁盘；</p>
<p>redo log是位于mysql引擎层的（mysql大体分为server层和引擎层），并且其大小是固定的，可以循环写入（使用双指针保证可写入位置，write pos是当前记录的位置，一边写一边后移；checkpoint是当前要擦除的位置，也是往后推移并且循环的，擦除记录前要把记录更新到数据文 件）</p>
<p>redo log保证了mysql具有crash-safe（崩溃安全）能力，</p>
<p><strong>保证redo log能够有比较好的IO性能</strong></p>
<p>A. 尽量保持Redo Log存储在一段连续的空间上。因此在系统第一次启动时就会将日志文件的空间完全分配。以顺序追加的方式记录Redo Log,通过顺序IO来改善性能。<br>B. 批量写入日志。日志并不是直接写入文件，而是先写入redo log buffer.当需要将日志刷新到磁盘时(如事务提交),将许多日志一起写入磁盘.<br>C. 并发的事务共享Redo Log的存储空间，它们的Redo Log按语句的执行顺序，依次交替的记录在一起，以减少日志占用的空间。例如,Redo Log中的记录内容可能是这样的：<br>记录1: &lt;trx1, insert …&gt;<br>记录2: &lt;trx2, update …&gt;<br>记录3: &lt;trx1, delete …&gt;<br>记录4: &lt;trx3, update …&gt;<br>记录5: &lt;trx2, insert …&gt;<br>D. 因为C的原因,当一个事务将Redo Log写入磁盘时，也会将其他未提交的事务的日志写入磁盘。<br>E. Redo Log上只进行顺序追加的操作，当一个事务需要回滚时，它的Redo Log记录也不会从Redo Log中删除掉。</p>
<h3 id="undo-redo"><a href="#undo-redo" class="headerlink" title="undo + redo"></a>undo + redo</h3><p><strong>流程：</strong></p>
<p><strong>假设 有A  值为1.</strong></p>
<p><strong>A.事务开始.</strong></p>
<p><strong>B.记录A=1到undo log.</strong></p>
<p><strong>C.修改A=3.</strong></p>
<p><strong>D.记录A=3到redo log.（此时redolog处于prepare状态）</strong></p>
<p><strong>E.告诉执行器，随时可以提交事务，然后执行器生成这个操作的binlog，并把binlog写入磁盘</strong></p>
<p><strong>F.执行器调用引擎的提交事务接口，引擎把刚刚写入的redo log改成提交（commit）状态，事务完成。</strong></p>
<p><strong>Undo + Redo事务的特点</strong><br>A. 为了保证持久性，必须在事务提交前将Redo Log持久化。<br>B. 数据不需要在事务提交前写入磁盘，而是缓存在内存中。<br>C. Redo Log 保证事务的持久性。<br>D. Undo Log 保证事务的原子性。<br>E. 有一个隐含的特点，数据必须要晚于redo log写入持久存储。</p>
<h3 id="binlog（归档日志）"><a href="#binlog（归档日志）" class="headerlink" title="binlog（归档日志）"></a>binlog（归档日志）</h3><p>redolog 是InnoDB特有的，是物理日志 ，记录的是“在某个数据页上做了什么修改”；，通过循环写，空间固定会用完；</p>
<p>binlog是server层实现，所有引擎都可以使用，逻辑日志，记录原始逻辑，比如“给ID=2这一行的c字段加1 ”；追加写入，不会覆盖以前的日志。只依靠binlog是没有crash-safe能力的。</p>
<h3 id="两阶段提交"><a href="#两阶段提交" class="headerlink" title="两阶段提交"></a>两阶段提交</h3><ol>
<li>执行器先找引擎取ID=2这一行。ID是主键，引擎直接用树搜索找到这一行。如果ID=2这一行所在的数据页本来就在内存中，就直接返回给执行器；否则，需要先从磁盘读入内存，然后再返回。</li>
<li>执行器拿到引擎给的行数据，把这个值加上1，比如原来是N，现在就是N+1，得到新的一行数据，再调用引擎接口写入这行新数据。</li>
<li>引擎将这行新数据更新到内存中，同时将这个更新操作记录到redo log里面，此时redo log处于prepare状态。然后告知执行器执行完成了，随时可以提交事务。</li>
<li>执行器生成这个操作的binlog，并把binlog写入磁盘。</li>
<li>执行器调用引擎的提交事务接口，引擎把刚刚写入的redo log改成提交（commit）状态，更新完成。</li>
</ol>
<p><img src="//qx-ljy.cn/2020/02/10/Mysql详解/C:%5CUsers%5C%E5%A4%95%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200210133758200.png" alt="image-20200210133758200"></p>
<p><strong>不用两阶段提交，会产生什么？</strong></p>
<ol>
<li><strong>先写redo log后写binlog</strong>。假设在redo log写完，binlog还没有写完的时候，MySQL进程异<br>常重启。由于我们前面说过的，redo log写完之后，系统即使崩溃，仍然能够把数据恢复回<br>来，所以恢复后这一行c的值是1。<br>但是由于binlog没写完就crash了，这时候binlog里面就没有记录这个语句。因此，之后备份<br>日志的时候，存起来的binlog里面就没有这条语句。<br>然后你会发现，如果需要用这个binlog来恢复临时库的话，由于这个语句的binlog丢失，这<br>个临时库就会少了这一次更新，恢复出来的这一行c的值就是0，与原库的值不同。</li>
<li><strong>先写binlog后写redo log</strong>。如果在binlog写完之后crash，由于redo log还没写，崩溃恢复以<br>后这个事务无效，所以这一行c的值是0。但是binlog里面已经记录了“把c从0改成1”这个日<br>志。所以，在之后用binlog来恢复的时候就多了一个事务出来，恢复出来的这一行c的值就是<br>1，与原库的值不同。</li>
</ol>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><p><strong>事务的特性</strong>：ACID ： 原子性    一致性    隔离性    持久性</p>
<h3 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h3><p><strong>读未提交：别人改数据的事务尚未提交，我在我的事务中也能读到。</strong><br><strong>读已提交：别人改数据的事务已经提交，我在我的事务中才能读到。</strong><br><strong>可重复读：别人改数据的事务已经提交，我在我的事务中也不去读。</strong><br><strong>串行化：我的事务尚未提交，别人就别想改数据。</strong><br><strong>这4种隔离级别，并行性能依次降低，安全性依次提高。</strong></p>
<p>在实现上，数据库里面会创建一个视图，访问的时候以视图的逻辑结果为准。</p>
<p>在“可重复读”隔离 级别下，这个视图是在事务启动时创建的，整个事务存在期间都用这个视图。</p>
<p>在“读提交”隔离级 别下，这个视图是在每个SQL语句开始执行的时候创建的。</p>
<p>“读未提交”隔离 级别下直接返回记录上的最新值，没有视图概念；</p>
<p>而“串行化”隔离级别下直接用加锁的方式来避 免并行访问。</p>
<p><strong>默认使用读提交。</strong></p>
<p><strong>1、回滚日志什么时候删除？</strong></p>
<p>系统会判断当没有事务需要用到这些回滚日志的时候，回滚日志会被删除</p>
<p><strong>2、什么时候不需要了？</strong></p>
<p>当系统里没有比这个回滚日志更早的read-view的时候。</p>
<p><strong>3、为什么尽量不要使用长事务</strong></p>
<p>长事务意味着系统里面会存在很老的事务视图，在这个事务提交之前，回滚记录都要保留，这会导致大量占用存储空间。除此之外，长事务还占用锁资源，可能会拖垮库。</p>
<h3 id="恢复策略"><a href="#恢复策略" class="headerlink" title="恢复策略"></a>恢复策略</h3><p>未提交的事务和回滚了的事务也会记录Redo Log，因此在进行恢复时,这些事务要进行特殊的的处理.</p>
<p>有2中不同的恢复策略：</p>
<blockquote>
<p>A. 进行恢复时，只重做已经提交了的事务。<br>B. 进行恢复时，重做所有事务包括未提交的事务和回滚了的事务。然后通过Undo Log回滚那些<br>未提交的事务。</p>
</blockquote>
<p><strong>MySQL数据库InnoDB存储引擎使用了B策略</strong></p>
<p> InnoDB存储引擎中的恢复机制有几个特点：</p>
<p><strong>A. 在重做Redo Log时，并不关心事务性。</strong> 恢复时，没有BEGIN，也没有COMMIT,ROLLBACK的行为。也不关心每个日志是哪个事务的。尽管事务ID等事务相关的内容会记入Redo Log，这些内容只是被当作要操作的数据的一部分。<br><strong>B. 使用B策略就必须要将Undo Log持久化，而且必须要在写Redo Log之前将对应的Undo Log写入磁盘。</strong>Undo和Redo Log的这种关联，使得持久化变得复杂起来。<strong>为了降低复杂度，InnoDB将Undo Log看作数据，因此记录Undo Log的操作也会记录到redo log中。这样undo log就可以象数据一样缓存起来，而不用在redo log之前写入磁盘了。</strong><br>包含Undo Log操作的Redo Log，看起来是这样的：<br>记录1: &lt;trx1, Undo log insert &lt;undo_insert …&gt;&gt;<br>记录2: &lt;trx1, insert …&gt;<br>记录3: &lt;trx2, Undo log insert &lt;undo_update …&gt;&gt;<br>记录4: &lt;trx2, update …&gt;<br>记录5: &lt;trx3, Undo log insert &lt;undo_delete …&gt;&gt;<br>记录6: &lt;trx3, delete …&gt;<br>C. <strong>既然Redo没有事务性，那岂不是会重新执行被回滚了的事务？</strong><br><strong>确实是这样。同时Innodb也会将事务回滚时的操作也记录到redo log中。回滚操作本质上也是对数据进行修改，因此回滚时对数据的操作也会记录到Redo Log中。</strong><br>一个回滚了的事务的Redo Log，看起来是这样的：<br>记录1: &lt;trx1, Undo log insert &lt;undo_insert …&gt;&gt;<br>记录2: &lt;trx1, insert A…&gt;<br>记录3: &lt;trx1, Undo log insert &lt;undo_update …&gt;&gt;<br>记录4: &lt;trx1, update B…&gt;<br>记录5: &lt;trx1, Undo log insert &lt;undo_delete …&gt;&gt;<br>记录6: &lt;trx1, delete C…&gt;<br>记录7: &lt;trx1, insert C&gt;<br>记录8: &lt;trx1, update B to old value&gt;<br>记录9: &lt;trx1, delete A&gt;</p>
<p><strong>一个被回滚了的事务在恢复时的操作就是先redo再undo，因此不会破坏数据的一致性.</strong></p>
<h3 id="脏读、幻读、不可重复读"><a href="#脏读、幻读、不可重复读" class="headerlink" title="脏读、幻读、不可重复读"></a>脏读、幻读、不可重复读</h3><h4 id="1、脏读："><a href="#1、脏读：" class="headerlink" title="1、脏读："></a>1、脏读：</h4><p>  当数据库中一个事务A正在修改一个数据但是还未提交或者回滚，<br>  另一个事务B 来读取了修改后的内容并且使用了，<br>  之后事务A提交了，此时就引起了脏读。 </p>
<p>  <strong>此情况仅会发生在： 读未提交的的隔离级别.</strong></p>
<h4 id="2、不可重复读："><a href="#2、不可重复读：" class="headerlink" title="2、不可重复读："></a>2、不可重复读：</h4><p>在一个事务A中多次操作数据，在事务操作过程中(未最终提交)，事务B也才做了处理，并且该值发生了改变，这时候就会导致A在事务操作的时候，发现数据与第一次不一样了。 就是不可重复读。</p>
<p>  <strong>此情况仅会发生在：读未提交、读提交的隔离级别.</strong></p>
<h4 id="3、幻读"><a href="#3、幻读" class="headerlink" title="3、幻读"></a>3、幻读</h4><p>  一个事务按相同的查询条件重新读取以前检索过的数据，却发现其他事务插入了满足其查询条件的新数据，这种现象就称为幻读。</p>
<p>幻读是指当事务不是独立执行时发生的一种现象.</p>
<p>例如第一个事务对一个表中的数据进行了修改，比如这种修改涉及到表中的“全部数据行”。</p>
<p>同时，第二个事务也修改这个表中的数据，这种修改是向表中插入“一行新数据”。</p>
<p>那么，以后就会发生操作第一个事务的用户发现表中还存在没有修改的数据行，就好象发生了幻觉一样. 一般解决幻读的方法是增加范围锁RangeS，锁定检索范围为只读，这样就避免了幻读。</p>
<p>  <strong>此情况会回发生在：读未提交、读提交、可重复读的隔离级别.</strong></p>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><h3 id="索引模型"><a href="#索引模型" class="headerlink" title="索引模型"></a>索引模型</h3><p><img src="https://img2018.cnblogs.com/blog/1075436/201903/1075436-20190306160941579-1127184320.png" alt="img"></p>
<h3 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h3><p><strong>索引类型</strong></p>
<p><strong>主键索引：</strong>主键索引的叶子节点存的是整行的数据(聚簇索引)，</p>
<p><strong>非主键索引：</strong>非主键索引的叶子节点内容是主键的值(二级索引) </p>
<p><strong>主键索引和普通索引的区别：</strong></p>
<p>1、主键索引只要搜索ID这个B+Tree即可拿到数据。<br>        如果语句是 select * from T where ID=500，即主键查询方式，则只需要搜索 ID 这棵 B+ 树</p>
<p>2、普通索引先搜索索引拿到主键值，再到主键索引树搜索一次(回表)<br>        如果语句是 select * from T where k=k=5，即普通索引查询方式，则需要先搜索 k 索引树，得到到         ID 的值为 500，再到 ID 索引树搜索一次。这个过程为回表也就是说，基于非主键索引的查询需要        多扫描一棵树</p>
<p><strong>也就是说，基于非主键索引的查询需要多扫描一棵树，因此，我们在应用中应该尽量使用主键查询</strong></p>
<p><strong>主键长度越小，普通索引的叶子节点就越小，普通索引占用的空间也就越小</strong></p>
<p><strong>最左前缀原则</strong></p>
<p><strong>不只是索引的全部定义，只要满足最左前缀，就可以可利用索引来加速检索、这个最左前缀可以是联合索引的最左N个字段，也可以是字符串索引的最左M个字符</strong></p>
<h2 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h2><h3 id="全局锁"><a href="#全局锁" class="headerlink" title="全局锁"></a>全局锁</h3><p>全局锁就是对整个数据库实例加锁。<br>MySQL 提供了一个加全局读锁的方法，命令是 Flush tables with read lock (FTWRL)。当你需要让整个库处于只读状态的时候，可以使用这个命令，之后其他线程的以下语句会被阻塞：</p>
<ul>
<li>1、数据更新语句（数据的增删改）</li>
<li>2、数据定义语句（包括建表、修改表结构等）</li>
<li>3、更新类事务的提交语句。</li>
</ul>
<p><strong>全局锁使用场景</strong></p>
<p>全局锁的典型使用场景是，做全库逻辑备份、也就是把整库每个表都 select 出来存成文本。</p>
<p><strong>缺点</strong></p>
<p>以前有一种做法，是通过 FTWRL 确保不会有其他线程对数据库做更新，然后对整个库做备份。注意，在备份过程中整个库完全处于只读状态。但是让整库都只读，听上去就很危险：</p>
<ol>
<li>如果你在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆；</li>
<li>如果你在从库上备份，那么备份期间从库不能执行主库同步过来的 binlog，会导致主从延迟</li>
</ol>
<p><strong>官方自带的逻辑备份工具是 mysqldump。当 mysqldump 使用参数–single-transaction的时候，导数据之前就会启动一个事务（可重复读），来确保拿到一致性视图。而由于 MVCC 的支持，这个过程中数据是可以正常更新的。</strong></p>
<p><strong>一致性读是好，但前提是引擎要支持这个隔离级别</strong>。比如，对于 MyISAM 这种不支持事务的引擎，如果备份过程中有更新，总是只能取到最新的数据，那么就破坏了备份的一致性。这时，我们就需要使用FTWRL 命令了。</p>
<p><strong>所以，single-transaction 方法只适用于所有的表使用事务引擎的库。如果有的表使用了不支持事务的引擎，那么备份就只能通过 FTWRL 方法。</strong>这往往是 DBA 要求业务开发人员使用 InnoDB 替代 MyISAM 的原因之一。  </p>
<p>你也许会问，既然要全库只读，<strong>为什么不使用 set global readonly=true 的方式呢？</strong>确实 readonly 方式也可以让全库进入只读状态，但我还是会建议你用 FTWRL 方式，主要有两个原因：</p>
<ul>
<li>一是，在有些系统中，readonly 的值会被用来做其他逻辑，比如用来判断一个库是主库还是备库。因此，修改 global 变量的方式影响面更大，我不建议你使用。</li>
<li>二是，在异常处理机制上有差异。如果执行 FTWRL 命令之后由于客户端发生异常断开，那么 MySQL 会自动释放这个全局锁，整个库回到可以正常更新的状态。<strong>而将整个 库设置为 readonly 之后，如果客户端发生异常，则数据库就会一直保持 readonly 状态，这样会导致整个库长时间处于不可写状态，风险较高。</strong></li>
</ul>
<h3 id="表级锁"><a href="#表级锁" class="headerlink" title="表级锁"></a>表级锁</h3><p>MySQL 里面表级别的锁有两种：一种是表锁，一种是元数据锁（meta data lock，MDL)</p>
<h4 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h4><p><strong>表锁的语法是 lock tables … read/write。与 FTWRL 类似，可以用 unlock tables 主动释放锁，也可以在客户端断开的时候自动释放。需要注意，lock tables 语法除了会限制别的线程的读写外，也限定了本线程接下来的操作对象。</strong></p>
<p>举个例子, 如果在某个线程 A 中执行 lock tables t1 read, t2 write; 这个语句，则其他线程写 t1、读写 t2 的语句都会被阻塞。同时，线程 A 在执行 unlock tables 之前，也只能执行读 t1、读写 t2 的操作。连写 t1 都不允许，自然也不能访问其他表。</p>
<p>在还没有出现更细粒度的锁的时候，表锁是最常用的处理并发的方式。而对于 InnoDB 这种支持行锁的引擎，一般不使用 lock tables 命令来控制并发，毕竟锁住整个表的影响面还是太大。</p>
<h4 id="元数据锁"><a href="#元数据锁" class="headerlink" title="元数据锁"></a>元数据锁</h4><p>另一类表级的锁是 MDL（metadata lock)。MDL 不需要显式使用，在访问一个表的时候会被自动加上。MDL 的作用是，保证读写的正确性。你可以想象一下，如果一个查询正在遍历一个表中的数据，而执行期间另一个线程对这个表结构做变更，删了一列，那么查<br>询线程拿到的结果跟表结构对不上，肯定是不行的。</p>
<p>因此，在 MySQL 5.5 版本中引入了 MDL，当对一个表做增删改查操作的时候，加 MDL读锁；当要对表做结构变更操作的时候，加 MDL 写锁。</p>
<ul>
<li>读锁之间不互斥，因此你可以有多个线程同时对一张表增删改查（这里增删改查对于表中数据，所以出现脏读、幻读、不可重复读；记住这是表级锁，为的是表结构统一）。</li>
<li>读写锁之间、写锁之间是互斥的，用来保证变更表结构操作的安全性。因此，如果有两个线程要同时给一个表加字段，其中一个要等另一个执行完才能开始执行。</li>
</ul>
<h3 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h3><p>MySQL 的行锁是在引擎层由各个引擎自己实现的。但并不是所有的引擎都支持行锁，比如 MyISAM 引擎就不支持行锁。不支持行锁意味着并发控制只能使用表锁，对于这种引擎的表，同一张表上任何时刻只能有一个更新在执行，这就会影响到业务并发度。InnoDB是支持行锁的，这也是 MyISAM 被 InnoDB 替代的重要原因之一。</p>
<p>我们今天就主要来聊聊 InnoDB 的行锁，以及如何通过减少锁冲突来提升业务并发度。</p>
<p><strong>顾名思义，行锁就是针对数据表中行记录的锁。这很好理解，比如事务 A 更新了一行，而这时候事务 B 也要更新同一行，则必须等事务 A 的操作完成后才能进行更新。</strong></p>
<p>当然，数据库中还有一些没那么一目了然的概念和设计，这些概念如果理解和使用不当，容易导致程序出现非预期行为，比如<strong>两阶段锁</strong>。</p>
<p><strong>在 InnoDB 事务中，行锁是在需要的时候才加上的，但并不是不需要了就立刻释放，而是要等到事务结束时才释放。这个就是两阶段锁协议。</strong></p>
<h3 id="死锁和死锁等待"><a href="#死锁和死锁等待" class="headerlink" title="死锁和死锁等待"></a>死锁和死锁等待</h3><p>当并发系统中不同线程出现循环资源依赖，涉及的线程都在等待别的线程释放资源时，就会导致这几个线程都进入无限等待的状态，称为死锁。</p>
<p><strong>当出现死锁以后，有两种策略</strong></p>
<p><strong>一种策略是，直接进入等待，直到超时。</strong>这个超时时间可以通过参数innodb_lock_wait_timeout 来设置。</p>
<p><strong>另一种策略是，发起死锁检测，发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行</strong>。将参数 innodb_deadlock_detect 设置为 on，表示开启这个逻辑。</p>
<p><strong>1、InnoDB 中，innodb_lock_wait_timeout 的默认值是？</strong></p>
<p>在 InnoDB 中，innodb_lock_wait_timeout 的默认值是 50s</p>
<p><strong>2、innodb_lock_wait_timeout 设置大小的影响</strong></p>
<p>在 InnoDB 中，innodb_lock_wait_timeout 的默认值是 50s，<strong>意味着如果采用第一个策略，当出现死锁以后，第一个被锁住的线程要过 50s 才会超时退出，然后其他线程才有可能继续执行。对于在线服务来说，这个等待时间往往是无法接受的</strong>。但是，我们又不可能直接把这个<strong>时间设置成一个很小的值</strong>，比如 1s。这样当出现死锁的时候，确实很快就可以解开，<strong>但如果不是死锁，而是简单的锁等待呢？</strong>所以，*<em>超时时间设置太短的话，会出现很多误伤。 *</em></p>
<p><strong>正常情况下我们采用第二种策略</strong></p>
<p>所以，正常情况下我们还是要采用第二种策略，即：主动死锁检测，而且innodb_deadlock_detect 的默认值本身就是 on。<strong>主动死锁检测在发生死锁的时候，是能够快速发现并进行处理的，但是它也是有额外负担的。</strong>你可以想象一下这个过程<strong>：每当一个事务被锁的时候，就要看看它所依赖的线程有没有被别人锁住，如此循环，最后判断是否出现了循环等待，也就是死锁。</strong></p>
<p><strong>第二种策略存在的问题解决</strong></p>
<p>每个新来的被堵住的线程，都要判断会不会由于自己的加入导致了死锁，这是一个时间复<br>杂度是 O(n) 的操作。假设有 1000 个并发线程要同时更新同一行，那么死锁检测操作就<br>是 100 万这个量级的。虽然最终检测的结果是没有死锁，但是这期间要消耗大量的 CPU<br>资源。因此，你就会看到 CPU 利用率很高，但是每秒却执行不了几个事务。</p>
<ol>
<li><p><strong>如果你能确保这个业务一定不会出现死锁，可以临时把死锁检测关掉</strong></p>
</li>
<li><p><strong>控制并发度</strong>  </p>
<p> 根据上面的分析，你会发现如果并发能够控制住，比如同一行同时最多只有 10 个线程在更新，那么死锁检测的成本很低，就不会出现这个问题。一个直接的想法就是，<strong>在客户端做并发控制。但是，你会很快发现这个方法不太可行，因为客户端很多</strong>。我见过一个应用，有 600 个客户端，这样即使每个客户端控制到只有 5 个并发线程，汇总到数据库服务端以后，峰值并发数也可能要达到 3000。</p>
<p> 因此，<strong>这个并发控制要做在</strong></p>
<p> 1、数据库服务端。</p>
<p> 2、如果你有中间件，可以考虑在中间件实现；基本思路就是，对于相同行的更新，在进入引擎之前排队。这样在 InnoDB 内部就不会有大量的死锁检测工作了</p>
<p> 3、如果你的团队有能修改 MySQL 源码的人，也可以做在 MySQL 里面。</p>
</li>
</ol>
<p><strong>悲观锁(Pessimistic Locking)，悲观锁是指在数据处理过程，使数据处于锁定状态，一般使用数据库的锁机制实现。</strong></p>
<p><strong>乐观锁相对悲观锁而言，它认为数据一般情况下不会造成冲突，所以在数据进行提交更新的时候，才会正式对数据的冲突与否进行检测，如果发现冲突了，则让返回错误信息，让用户决定如何去做。</strong></p>
<h2 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h2><h3 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h3><p>（1）<code>Master</code>服务器将数据的改变记录二进制<code>Binlog</code>日志，当<code>Master</code>上的数据发生改变时，则将其改变写入二进制日志中；</p>
<p>（2）<code>Slave</code>服务器会在一定时间间隔内对<code>Master</code>二进制日志进行探测其是否发生改变，如果发生改变，则开始一个<code>I/OThread</code>请求<code>Master</code>二进制事件</p>
<p>（3）同时主节点为每个<code>I/O</code>线程启动一个<code>Dump</code>线程，用于向其发送二进制事件，并保存至从节点本地的中继日志中，从节点将启动SQL线程从中继日志中读取二进制日志，在本地重放，使得其数据和主节点的保持一致，最后<code>I/OThread</code>和<code>SQLThread</code>将进入睡眠状态，等待下一次被唤醒。</p>

      
    </div>
    
    
    

	<div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2020/02/10/Mysql详解/">Mysql详解</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 青夕 的个人博客">青夕</a></p>
  <p><span>发布时间:</span>2020年02月10日 - 12:02</p>
  <p><span>最后更新:</span>2020年03月27日 - 15:03</p>
  <p><span>原始链接:</span><a href="/2020/02/10/Mysql详解/" title="Mysql详解">http://qx-ljy.cn/2020/02/10/Mysql详解/</a>
    <span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="http://qx-ljy.cn/2020/02/10/Mysql详解/" aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
	  $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
	    });
    });  
</script>


      
	</div>

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt="青夕 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="青夕 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Mysql/" rel="tag"># Mysql</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/02/09/Netty详解/" rel="next" title="Netty详解">
                <i class="fa fa-chevron-left"></i> Netty详解
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/02/12/Zookeeper详解/" rel="prev" title="Zookeeper详解">
                Zookeeper详解 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="青夕">
            
              <p class="site-author-name" itemprop="name">青夕</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">37</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">23</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">25</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Mysql逻辑结构"><span class="nav-number">1.</span> <span class="nav-text">Mysql逻辑结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#长连接-and-短连接"><span class="nav-number">1.1.</span> <span class="nav-text">长连接 and 短连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#长连接的缺点和解决方案"><span class="nav-number">1.2.</span> <span class="nav-text">长连接的缺点和解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询缓存"><span class="nav-number">1.3.</span> <span class="nav-text">查询缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优化器"><span class="nav-number">1.4.</span> <span class="nav-text">优化器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行器"><span class="nav-number">1.5.</span> <span class="nav-text">执行器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志系统"><span class="nav-number">2.</span> <span class="nav-text">日志系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#undo日志"><span class="nav-number">2.1.</span> <span class="nav-text">undo日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redo-log"><span class="nav-number">2.2.</span> <span class="nav-text">redo log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#undo-redo"><span class="nav-number">2.3.</span> <span class="nav-text">undo + redo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#binlog（归档日志）"><span class="nav-number">2.4.</span> <span class="nav-text">binlog（归档日志）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#两阶段提交"><span class="nav-number">2.5.</span> <span class="nav-text">两阶段提交</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务"><span class="nav-number">3.</span> <span class="nav-text">事务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#事务的隔离级别"><span class="nav-number">3.1.</span> <span class="nav-text">事务的隔离级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#恢复策略"><span class="nav-number">3.2.</span> <span class="nav-text">恢复策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#脏读、幻读、不可重复读"><span class="nav-number">3.3.</span> <span class="nav-text">脏读、幻读、不可重复读</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1、脏读："><span class="nav-number">3.3.1.</span> <span class="nav-text">1、脏读：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2、不可重复读："><span class="nav-number">3.3.2.</span> <span class="nav-text">2、不可重复读：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3、幻读"><span class="nav-number">3.3.3.</span> <span class="nav-text">3、幻读</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#索引"><span class="nav-number">4.</span> <span class="nav-text">索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#索引模型"><span class="nav-number">4.1.</span> <span class="nav-text">索引模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InnoDB"><span class="nav-number">4.2.</span> <span class="nav-text">InnoDB</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#锁"><span class="nav-number">5.</span> <span class="nav-text">锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#全局锁"><span class="nav-number">5.1.</span> <span class="nav-text">全局锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表级锁"><span class="nav-number">5.2.</span> <span class="nav-text">表级锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#表锁"><span class="nav-number">5.2.1.</span> <span class="nav-text">表锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#元数据锁"><span class="nav-number">5.2.2.</span> <span class="nav-text">元数据锁</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#行锁"><span class="nav-number">5.3.</span> <span class="nav-text">行锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#死锁和死锁等待"><span class="nav-number">5.4.</span> <span class="nav-text">死锁和死锁等待</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群"><span class="nav-number">6.</span> <span class="nav-text">集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主从复制"><span class="nav-number">6.1.</span> <span class="nav-text">主从复制</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

	
		<script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
		<script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
		<div class="widget-wrap">
			<h3 class="widget-title">Tag Cloud</h3>
			<div id="myCanvasContainer" class="widget tagcloud">
			<canvas width="250" height="250" id="resCanvas" style="width=100%">
				<ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/">Kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/">Kubernetes</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LeetCode/">LeetCode</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/">Mysql</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NIO/">NIO</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/">Netty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/">Spring</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TDengine/">TDengine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/">Zookeeper</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/">markdown</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netty/">netty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/二分查找/">二分查找</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/分布式/">分布式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/区块链/">区块链</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并发/">并发</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络协议/">网络协议</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/计算机网络/">计算机网络</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a><span class="tag-list-count">1</span></li></ul>
			</canvas>
		</div>
		</div>
	
    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">青夕</span>

  
</div>




  <span class="post-meta-divider">吉ICP备19004601号|</span>





<div class="powered-by">|
<i class="fa fa-user-md"></i>
	<span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
</span>

</div>



        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

    <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>

  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)

        if(result)$(this).text('复制成功')
        else $(this).text('复制失败')

        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>


</body>
<script type="text/javascript" src="/js/src/dynamic_bg.js"></script>
</html>
